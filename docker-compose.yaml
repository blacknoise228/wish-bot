services:
  postgresdb:
    image: postgres:17-alpine3.20
    environment: 
      - POSTGRES_USER=root
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=wishbot
    volumes:
      - db_data:/var/lib/postgresql/data  
    ports:
      - "6432:5432"
    restart: always

  wishbot:
    build:
      context: .
    environment:
      - TZ=Asia/Almaty
      - WISHBOT_TELEGRAM_TOKEN=${WISHBOT_TELEGRAM_TOKEN}
      - WISHBOT_POSTGRES_HOST=postgresdb:5432
      - WISHBOT_APP_ENVIRONMENT=stage
    depends_on:
      - postgresdb
    ports:
      - "3000:3000"
    restart: always
    volumes:
      - /usr/share/zoneinfo/Asia:/usr/share/zoneinfo/Asia:ro
    command: bot

  migration:
    build:
      context: .
    environment:
      - WISHBOT_POSTGRES_HOST=postgresdb:5432
      - WISHBOT_APP_ENVIRONMENT=stage
    depends_on:
      - postgresdb
    command: migrate


volumes:
  db_data:    